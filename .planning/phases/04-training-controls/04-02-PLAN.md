---
phase: 04-training-controls
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/web/server.py
  - src/web/templates/index.html
  - src/web/static/styles.css
autonomous: true
user_setup: []

must_haves:
  truths:
    - "WebSocket handles pause, resume, set_mode, set_speed commands"
    - "UI has pause/resume button that changes label based on state"
    - "UI has visual mode toggle switch"
    - "UI has speed slider control"
    - "Status indicator shows 'Paused' state distinctly"
  artifacts:
    - path: "src/web/server.py"
      provides: "WebSocket command handlers for pause/resume/mode/speed"
      contains: "pause_training"
    - path: "src/web/templates/index.html"
      provides: "UI controls for pause, mode toggle, speed slider"
      contains: "btn-pause"
    - path: "src/web/static/styles.css"
      provides: "Styling for new controls"
      contains: "speed-slider"
  key_links:
    - from: "src/web/server.py"
      to: "src/web/training_manager.py"
      via: "training_manager.pause_training()"
      pattern: "training_manager\\.(pause|resume|set_mode|set_speed)"
---

<objective>
Add WebSocket command handlers for training controls and UI elements for pause/resume, mode toggle, and speed slider.

Purpose: Connect the backend control infrastructure (from Plan 01) to the web UI, completing the server-to-frontend control path.
Output: WebSocket handlers for all control commands and HTML/CSS for the new UI controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-training-controls/04-01-SUMMARY.md

# Files to modify
@src/web/server.py
@src/web/templates/index.html
@src/web/static/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WebSocket command handlers for controls</name>
  <files>src/web/server.py</files>
  <action>
Add handlers for pause, resume, set_mode, and set_speed commands in the WebSocket endpoint:

1. In the websocket_endpoint() function, add these command handlers after the existing "stop" handler:

```python
elif command == "pause":
    if training_manager.pause_training():
        await connection_manager.send_to(
            websocket,
            {
                "type": "status",
                "status": "paused",
                "message": "Training paused",
            },
        )
    else:
        await connection_manager.send_to(
            websocket,
            {
                "type": "error",
                "error": "Cannot pause - training not running",
            },
        )

elif command == "resume":
    if training_manager.resume_training():
        await connection_manager.send_to(
            websocket,
            {
                "type": "status",
                "status": "running",
                "message": "Training resumed",
            },
        )
    else:
        await connection_manager.send_to(
            websocket,
            {
                "type": "error",
                "error": "Cannot resume - training not paused",
            },
        )

elif command == "set_mode":
    visual = data.get("visual", False)
    training_manager.set_mode(visual)
    # Mode change confirmed via info message from callback
    await connection_manager.send_to(
        websocket,
        {
            "type": "info",
            "message": f"Mode change requested: {'visual' if visual else 'headless'}",
        },
    )

elif command == "set_speed":
    speed = data.get("speed", 1.0)
    # Clamp speed to valid range
    speed = max(0.1, min(1.0, float(speed)))
    training_manager.set_speed(speed)
    await connection_manager.send_to(
        websocket,
        {
            "type": "info",
            "message": f"Speed set to {speed:.1f}x",
        },
    )
```

2. Update the docstring for websocket_endpoint to include new commands:
```python
"""WebSocket endpoint for real-time updates and commands.

Accepts connections, receives JSON commands, and broadcasts metrics.
Commands:
    - {"command": "start", "config": {...}}: Start training
    - {"command": "stop"}: Stop training
    - {"command": "pause"}: Pause training
    - {"command": "resume"}: Resume training
    - {"command": "set_mode", "visual": true/false}: Toggle headless/visual mode
    - {"command": "set_speed", "speed": 0.1-1.0}: Set visualization speed
    - {"command": "status"}: Get current status
"""
```

3. Update get_status() handler to include current status (already returns status field, ensure it reflects paused state).
  </action>
  <verify>
Server starts without error:
`cd C:\Users\Blake\PycharmProjects\mlTetris && python -c "from src.web.server import app; print('Server imports OK')"`
  </verify>
  <done>
WebSocket endpoint handles pause, resume, set_mode, set_speed commands and routes them to TrainingManager.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add UI control elements to frontend</name>
  <files>src/web/templates/index.html, src/web/static/styles.css</files>
  <action>
Add HTML elements for pause/resume button, mode toggle, and speed slider:

**In index.html:**

1. Replace the existing controls div with enhanced version:
```html
<div class="controls">
    <div class="control-row">
        <button id="btn-start" class="btn btn-start">Start Training</button>
        <button id="btn-pause" class="btn btn-pause" disabled>Pause</button>
        <button id="btn-stop" class="btn btn-stop" disabled>Stop Training</button>
    </div>
</div>

<div class="control-section">
    <h3>Training Mode</h3>
    <div class="control-row">
        <label class="toggle-label">
            <span class="toggle-text">Headless (Fast)</span>
            <label class="toggle-switch">
                <input type="checkbox" id="mode-toggle">
                <span class="toggle-slider"></span>
            </label>
            <span class="toggle-text">Visual (Watch)</span>
        </label>
    </div>
</div>

<div class="control-section">
    <h3>Visualization Speed</h3>
    <div class="speed-control">
        <input type="range" id="speed-slider" min="0.1" max="1.0" step="0.1" value="1.0" disabled>
        <span id="speed-value">1.0x</span>
    </div>
    <p class="hint">Slower speed in visual mode for easier watching</p>
</div>
```

Place this after the existing config-section div (before closing </section>).

**In styles.css:**

Add these styles for the new controls:

```css
/* Control rows */
.control-row {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 15px;
}

/* Pause button */
.btn-pause {
    background-color: #f39c12;
    color: white;
}

.btn-pause:hover:not(:disabled) {
    background-color: #d68910;
}

.btn-pause:disabled {
    background-color: #bdc3c7;
    cursor: not-allowed;
}

/* Control section */
.control-section {
    margin-top: 20px;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.control-section h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #bdc3c7;
}

/* Toggle switch for mode */
.toggle-label {
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
}

.toggle-text {
    font-size: 14px;
    color: #ecf0f1;
}

.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #7f8c8d;
    transition: 0.3s;
    border-radius: 26px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
    background-color: #3498db;
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

.toggle-switch input:disabled + .toggle-slider {
    background-color: #34495e;
    cursor: not-allowed;
}

/* Speed slider */
.speed-control {
    display: flex;
    align-items: center;
    gap: 15px;
    justify-content: center;
}

#speed-slider {
    width: 200px;
    height: 8px;
    -webkit-appearance: none;
    appearance: none;
    background: #34495e;
    border-radius: 4px;
    outline: none;
}

#speed-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    background: #3498db;
    border-radius: 50%;
    cursor: pointer;
}

#speed-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    background: #3498db;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

#speed-slider:disabled {
    opacity: 0.5;
}

#speed-slider:disabled::-webkit-slider-thumb {
    background: #7f8c8d;
    cursor: not-allowed;
}

#speed-value {
    font-size: 14px;
    font-weight: bold;
    color: #3498db;
    min-width: 40px;
}

.hint {
    margin-top: 8px;
    font-size: 12px;
    color: #7f8c8d;
    text-align: center;
}

/* Paused status indicator */
.status.paused {
    background-color: rgba(243, 156, 18, 0.1);
    border-color: #f39c12;
}

.status.paused .status-dot {
    background-color: #f39c12;
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
```
  </action>
  <verify>
Open index.html in browser (with server running) and verify:
1. Pause button appears between Start and Stop
2. Mode toggle switch appears
3. Speed slider appears
4. Styling looks correct

Or verify HTML validity:
`python -c "from pathlib import Path; html = Path('src/web/templates/index.html').read_text(); print('btn-pause' in html and 'mode-toggle' in html and 'speed-slider' in html)"`
  </verify>
  <done>
UI has pause button, mode toggle switch, and speed slider with appropriate styling.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. Server imports without error: `python -c "from src.web.server import app; print('OK')"`
2. HTML contains all new elements: check for btn-pause, mode-toggle, speed-slider
3. CSS contains new styles: check for .toggle-switch, .speed-control
4. Start server and open http://localhost:8000 to visually verify UI elements
</verification>

<success_criteria>
- WebSocket handles pause, resume, set_mode, set_speed commands
- UI shows pause button (disabled by default)
- UI shows mode toggle switch (defaults to headless/off)
- UI shows speed slider (disabled by default)
- Status indicator has distinct "paused" styling (orange with pulse)
- All elements are styled consistently with existing UI
</success_criteria>

<output>
After completion, create `.planning/phases/04-training-controls/04-02-SUMMARY.md`
</output>
